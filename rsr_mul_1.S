
/*
 * rsr_mul_1.s
 *
 * Created: 2023-05-21 오후 3:12:35
 *  Author: mingi
 */ 
#include "common.i"

.global rsr_mul_1
.type rsr_mul_1, @function

#define L0 R19
#define L1 R18
#define L2 R17
#define L3 R16

// reduction 1
rsr_mul_1:
	PUSH_REGS
	MOVW R28, R24	// Y = R
	MOVW R30, R22	// Z = L
	MOVW R26, R18	// X = M

	LDD R2, Y+0
	LDD R3, Y+1
	LDD R4, Y+2
	LDD R5, Y+3
	LDD R6, Y+4
	LDD R7, Y+5
	LDD R8, Y+6
	LDD R9, Y+7
	LDD R10, Y+8
	LDD R11, Y+9
	LDD R12, Y+10
	LDD R13, Y+11
	CLR R14	// CARRY 를 위한 레지스터 0으로 세팅
	CLR R15	// BURROW 를 위한 레지스터 0으로 세팅
	CLC		// CARRY FLAG 0으로 세팅

	LDD L0, Z+0
	LDD L1, Z+1
	LDD L2, Z+2
	LDD L3, Z+3

	LDD R0, Z+20	// L20,...,L23,L0,...,L3,L0,...,L3,CARRY1
	ADD R2, R0
	LDD R0, Z+21
	ADC R3, R0
	LDD R0, Z+22
	ADC R4, R0
	LDD R0, Z+23
	ADC R5, R0
	LDD R0, Z+0		// 중복되는거 줄일 수 있는 방안?
	ADC R6, R0
	LDD R0, Z+1
	ADC R7, R0
	LDD R0, Z+2
	ADC R8, R0
	LDD R0, Z+3
	ADC R9, R0
	// LDD R0, Z+0
	ADC R10, L0
	// LDD R0, Z+1
	ADC R11, L1
	// LDD R0, Z+2
	ADC R12, L2
	// LDD R0, Z+3
	ADC R13, L3
	ADC R14, R1	// R14 = R14 + R1 + CARRY1

	LDD R0, Z+16	// L16,...,L19,L0,...,L7,CARRY2
	ADD R2, R0
	LDD R0, Z+17
	ADC R3, R0
	LDD R0, Z+18
	ADC R4, R0
	LDD R0, Z+19
	ADC R5, R0
	// LDD R0, Z+0
	ADC R6, L0
	// LDD R0, Z+1
	ADC R7, L1
	// LDD R0, Z+2
	ADC R8, L2
	// LDD R0, Z+3
	ADC R9, L3
	LDD R0, Z+4
	ADC R10, R0
	LDD R0, Z+5
	ADC R11, R0
	LDD R0, Z+6
	ADC R12, R0
	LDD R0, Z+7
	ADC R13, R0
	ADC R14, R1

	LDD R0, Z+12	// L12,...,L15,0,0,0,0,L0,...,L3,CARRY3
	ADD R2, R0
	LDD R0, Z+13
	ADC R3, R0
	LDD R0, Z+14
	ADC R4, R0
	LDD R0, Z+15
	ADC R5, R0
	ADC R6, R1
	ADC R7, R1
	ADC R8, R1
	ADC R9, R1
	// LDD R0, Z+0
	ADC R10, L0
	// LDD R0, Z+1
	ADC R11, L1
	// LDD R0, Z+2
	ADC R12, L2
	// LDD R0, Z+3
	ADC R13, L3
	ADC R14, R1

	// LDD R0, Z+0		// 0,...,0,L0,L1,L2,L3,CARRY4
	ADD R10, L0
	// LDD R0, Z+1
	ADC R11, L1
	// LDD R0, Z+2
	ADC R12, L2
	// LDD R0, Z+3
	ADC R13, L3
	ADC R14, R1

	LDD R0, Z+0		// 0,...,0,L0,L1,L2,L3,CARRY5
	ADD R10, L0
	// LDD R0, Z+1
	ADC R11, L1
	// LDD R0, Z+2
	ADC R12, L2
	// LDD R0, Z+3
	ADC R13, L3
	ADC R14, R1

	LDD R0, Z+0		// 0,...,0,L0,L1,L2,L3,CARRY6
	ADD R10, L0
	// LDD R0, Z+1
	ADC R11, L1
	// LDD R0, Z+2
	ADC R12, L2
	// LDD R0, Z+3
	ADC R13, L3
	ADC R14, R1

	LDD R0, Z+0		// 0,...,0,L0,L1,L2,L3,CARRY7
	ADD R10, L0
	// LDD R0, Z+1
	ADC R11, L1
	// LDD R0, Z+2
	ADC R12, L2
	// LDD R0, Z+3
	ADC R13, L3
	ADC R14, R1

	LDD R0, Z+4		// 0,...,0,L4,L5,L6,L7,CARRY8
	ADD R10, L0
	// LDD R0, Z+1
	ADC R11, L1
	// LDD R0, Z+2
	ADC R12, L2
	// LDD R0, Z+3
	ADC R13, L3
	ADC R14, R1

	LDD R0, Z+4		// L4,L5,L6,L7,0,...,0,BURROW1
	SUB R2, R0
	LDD R0, Z+5
	SBC R3, R0
	LDD R0, Z+6
	SBC R4, R0
	LDD R0, Z+7
	SBC R5, R0
	SBC R6, R1
	SBC R7, R1
	SBC R8, R1
	SBC R9, R1
	SBC R10, R1
	SBC R11, R1
	SBC R12, R1
	SBC R13, R1
	ADC R15, R1	// R15에 BURROW 저장
	
	LDD R0, Z+4		// L4,L5,L6,L7,0,...,0,BURROW2
	SUB R2, R0
	LDD R0, Z+5
	SBC R3, R0
	LDD R0, Z+6
	SBC R4, R0
	LDD R0, Z+7
	SBC R5, R0
	SBC R6, R1
	SBC R7, R1
	SBC R8, R1
	SBC R9, R1
	SBC R10, R1
	SBC R11, R1
	SBC R12, R1
	SBC R13, R1
	ADC R15, R1	// R15에 BURROW 저장

	SUB R2, L0		// L0,L1,L2,L3,0,...,0,BURROW3
	SBC R3, L1
	SBC R4, L2
	SBC R5, L3
	SBC R6, R1
	SBC R7, R1
	SBC R8, R1
	SBC R9, R1
	SBC R10, R1
	SBC R11, R1
	SBC R12, R1
	SBC R13, R1
	ADC R15, R1	// R15에 BURROW 저장

	SUB R2, L0		// L0,L1,L2,L3,0,...,0,BURROW4
	SBC R3, L1
	SBC R4, L2
	SBC R5, L3
	SBC R6, R1
	SBC R7, R1
	SBC R8, R1
	SBC R9, R1
	SBC R10, R1
	SBC R11, R1
	SBC R12, R1
	SBC R13, R1
	ADC R15, R1	// R15에 BURROW 저장

	SUB R2, L0		// L0,L1,L2,L3,0,...,0,BURROW5
	SBC R3, L1
	SBC R4, L2
	SBC R5, L3
	SBC R6, R1
	SBC R7, R1
	SBC R8, R1
	SBC R9, R1
	SBC R10, R1
	SBC R11, R1
	SBC R12, R1
	SBC R13, R1
	ADC R15, R1	// R15에 BURROW 저장

	SUB R2, L0		// L0,L1,L2,L3,0,...,0,BURROW6
	SBC R3, L1
	SBC R4, L2
	SBC R5, L3
	SBC R6, R1
	SBC R7, R1
	SBC R8, R1
	SBC R9, R1
	SBC R10, R1
	SBC R11, R1
	SBC R12, R1
	SBC R13, R1
	ADC R15, R1	// R15에 BURROW 저장
	
	LDD R0, Z+4		// L4,...,L15,BURROW7
	SUB R2, R0
	LDD R0, Z+5
	SBC R3, R0
	LDD R0, Z+6
	SBC R4, R0
	LDD R0, Z+7
	SBC R5, R0
	LDD R0, Z+8
	SBC R6, R0
	LDD R0, Z+9
	SBC R7, R0
	LDD R0, Z+10
	SBC R8, R0
	LDD R0, Z+11
	SBC R9, R0
	LDD R0, Z+12
	SBC R10, R0
	LDD R0, Z+13
	SBC R11, R0
	LDD R0, Z+14
	SBC R12, R0
	LDD R0, Z+15
	SBC R13, R0
	ADC R15, R1

	LDD R0, Z+4		// L4,...,L15,BURROW8
	SUB R2, R0
	LDD R0, Z+5
	SBC R3, R0
	LDD R0, Z+6
	SBC R4, R0
	LDD R0, Z+7
	SBC R5, R0
	LDD R0, Z+8
	SBC R6, R0
	LDD R0, Z+9
	SBC R7, R0
	LDD R0, Z+10
	SBC R8, R0
	LDD R0, Z+11
	SBC R9, R0
	LDD R0, Z+12
	SBC R10, R0
	LDD R0, Z+13
	SBC R11, R0
	LDD R0, Z+14
	SBC R12, R0
	LDD R0, Z+15
	SBC R13, R0
	ADC R15, R1

	SUB R2, L0		// L0,...,L11,BURROW9
	SBC R3, L1
	SBC R4, L2
	SBC R5, L3
	LDD R0, Z+4
	SBC R6, R0
	LDD R0, Z+5
	SBC R7, R0
	LDD R0, Z+6
	SBC R8, R0
	LDD R0, Z+7
	SBC R9, R0
	LDD R0, Z+8
	SBC R10, R0
	LDD R0, Z+9
	SBC R11, R0
	LDD R0, Z+10
	SBC R12, R0
	LDD R0, Z+11
	SBC R13, R0
	ADC R15, R1

	LDD R0, Z+8		// L8,...,L19,BURROW10
	SUB R2, R0
	LDD R0, Z+9
	SBC R3, R0
	LDD R0, Z+10
	SBC R4, R0
	LDD R0, Z+11
	SBC R5, R0
	LDD R0, Z+12
	SBC R6, R0
	LDD R0, Z+13
	SBC R7, R0
	LDD R0, Z+14
	SBC R8, R0
	LDD R0, Z+15
	SBC R9, R0
	LDD R0, Z+16
	SBC R10, R0
	LDD R0, Z+17
	SBC R11, R0
	LDD R0, Z+18
	SBC R12, R0
	LDD R0, Z+19
	SBC R13, R0
	ADC R15, R1

	MOVW R30, R20	// Z = H, 0,0,0,0,H24,...,H31,BURROW11
	LDD R0, Z+24
	SUB R6, R0
	LDD R0, Z+25
	SBC R7, R0
	LDD R0, Z+26
	SBC R8, R0
	LDD R0, Z+27
	SBC R9, R0
	LDD R0, Z+28
	SBC R10, R0
	LDD R0, Z+29
	SBC R11, R0
	LDD R0, Z+30
	SBC R12, R0
	LDD R0, Z+31
	SBC R13, R0
	ADC R15, R1

	LD R0, X+		// M0,...,M11,BURROW12
	SUB R2, R0
	LD R0, X+
	SBC R3, R0
	LD R0, X+
	SBC R4, R0
	LD R0, X+
	SBC R5, R0
	LD R0, X+
	SBC R6, R0
	LD R0, X+
	SBC R7, R0
	LD R0, X+
	SBC R8, R0
	LD R0, X+
	SBC R9, R0
	LD R0, X+
	SBC R10, R0
	LD R0, X+
	SBC R11, R0
	LD R0, X+
	SBC R12, R0
	LD R0, X+
	SBC R13, R0
	ADC R15, R1
	
	// R14, R15에 있는 CARRY/BURROW 처리해주기
	STD Y+0, R2
	STD Y+1, R3
	STD Y+2, R4
	STD Y+3, R5
	STD Y+4, R6
	STD Y+5, R7
	STD Y+6, R8
	STD Y+7, R9
	STD Y+8, R10
	STD Y+9, R11
	STD Y+10, R12
	STD Y+11, R13
	LDD R0, Y+48	// R[48]에 있는 CARRY 가져오기
	ADD R14, R0
	STD Y+48, R14	// CARRY 저장
	LDD R0, Y+49
	ADD R15, R0
	STD Y+49, R15	// BURROW 저장

	POP_REGS
RET
